#!/usr/bin/perl -W
# $Id$

use lib qw(../lib);
use XTWMon;
use strict;
use warnings;

use constant MAX_X => 11;
use constant MAX_Y => 12;
use constant MAX_Z => 16;

my $r = shift;
$r->content_type('text/html');
my $cgi = CGI->new();

my %p;
$p{t} = $cgi->param("t");
$p{p} = $cgi->param("p");
$p{z} = $cgi->param("z");
$p{hl} = $cgi->param("hl");

my ($clicku, $clickv) = (-1, -1);
my $click = $cgi->param("click");
if ($click && $click =~ /^\?(\d+),(\d+)$/) {
	($clicku, $clickv) = ($1, $2);
}

$p{t} = 315 unless defined $p{t} && $p{t} =~ /^\d+$/;
$p{p} = 15 unless defined $p{p} && $p{p} =~ /^\d+$/;
$p{z} = 0 unless defined $p{z} && $p{z} =~ /^-?\d+$/;
delete $p{hl} unless defined $p{hl} && ($p{hl} eq "service" or
																				$p{hl} eq "free" or
																				$p{hl} eq "down");

my $tp = ($p{t} - 30) % 360;
my $tn = ($p{t} + 30) % 360;
my $pp = ($p{p} - 30) % 360;
my $pn = ($p{p} + 30) % 360;
my $zp = $p{z} - 10;
my $zn = $p{z} + 10;

# Bounds.
$pp = 270 if $p{p} >= 270 && $pp < 270;
$pn =  90 if $p{p} <=  90 && $pn >  90;

$p{z} = ZOOM_MAX if $p{z} > ZOOM_MAX;
$p{z} = ZOOM_MIN if $p{z} < ZOOM_MIN;

$zp = ZOOM_MAX if $zp > ZOOM_MAX;
$zp = ZOOM_MIN if $zp < ZOOM_MIN;

$zn = ZOOM_MAX if $zn > ZOOM_MAX;
$zn = ZOOM_MIN if $zn < ZOOM_MIN;

$p{job} = $cgi->param('job');
$p{job} = 0 unless $p{job} && $p{job} =~ /^\d+$/;

# It is imperative that all variables affecting the URL
# be set before make_url() is called.

my $uri = $r->uri;

my %url_view = (
	left	=> make_url($uri, \%p, t => $tn),
	right	=> make_url($uri, \%p, t => $tp),
	up	  => make_url($uri, \%p, p => $pn),
	down  => make_url($uri, \%p, p => $pp),
	forw  => make_url($uri, \%p, z => $zn),
	back  => make_url($uri, \%p, z => $zp),
);

$r->print(<<EOF);
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN">

<html lang="en-US" xml:lang="en-US" xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Wired XT3 Monitor</title>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<link rel="stylesheet" type="text/css" href="main.css" media="screen" />
		<script type="text/javascript" src="main.js"></script>
		<script type="text/javascript" src="latest/jobs.js"></script>
	</head>
	<body>
		<map name="view" id="view">
			<area href="$url_view{up}"    shape="poly" alt="rotate up (theta++)" coords="43,0, 44,0, 45,0, 46,0, 47,0, 48,0, 49,0, 50,0, 51,1, 52,1, 53,2, 54,3, 54,4, 55,5, 56,5, 57,4, 58,4, 59,4, 59,5, 59,6, 59,7, 59,8, 59,9, 59,10, 59,11, 59,12, 59,13, 59,14, 59,15, 59,16, 58,17, 58,18, 58,19, 58,20, 58,21, 58,22, 58,23, 58,24, 57,24, 56,24, 55,23, 55,22, 54,21, 54,20, 53,19, 52,18, 51,17, 50,16, 49,15, 48,15, 48,14, 48,13, 49,12, 50,11, 49,10, 48,9, 47,9, 46,10, 46,11, 45,12, 45,13, 44,14, 44,15, 43,16, 43,17, 43,18, 43,19, 42,20, 42,21, 42,22, 42,23, 42,24, 42,25, 42,26, 41,27, 41,28, 41,29, 41,30, 41,31, 41,32, 41,33, 41,34, 40,35, 39,36, 38,36, 37,37, 36,38, 35,38, 34,38, 33,38, 33,37, 33,36, 33,35, 33,34, 33,33, 33,32, 33,31, 33,30, 33,29, 33,28, 33,27, 33,26, 33,25, 33,24, 34,23, 34,22, 34,21, 34,20, 34,19, 35,18, 35,17, 35,16, 35,15, 36,14, 36,13, 36,12, 36,11, 37,10, 37,9, 38,8, 38,7, 39,6, 39,5, 40,4, 40,3, 41,2, 42,1" />
			<area href="$url_view{down}"  shape="poly" alt="rotate down (theta--)" coords="59,51, 60,51, 61,51, 62,51, 62,52, 62,53, 62,54, 62,55, 62,56, 62,57, 62,58, 62,59, 62,60, 62,61, 62,62, 62,63, 62,64, 62,65, 61,66, 61,67, 61,68, 61,69, 61,70, 61,71, 60,72, 60,73, 60,74, 59,75, 59,76, 59,77, 59,78, 58,79, 58,80, 57,81, 57,82, 56,83, 56,84, 55,85, 55,86, 54,87, 53,88, 52,89, 51,89, 50,89, 49,89, 48,89, 47,89, 46,89, 45,89, 44,88, 43,88, 42,87, 41,86, 41,85, 40,84, 39,84, 38,85, 37,85, 36,85, 36,84, 36,83, 36,82, 36,81, 36,80, 36,79, 36,78, 36,77, 36,76, 36,75, 36,74, 36,73, 37,72, 37,71, 37,70, 37,69, 37,68, 37,67, 37,66, 37,65, 38,65, 39,65, 40,66, 40,67, 41,68, 41,69, 42,70, 43,71, 44,72, 45,73, 46,74, 47,74, 47,75, 47,76, 46,77, 45,78, 46,79, 47,80, 48,80, 49,79, 49,78, 50,77, 50,76, 51,75, 51,74, 52,73, 52,72, 52,71, 52,70, 53,69, 53,68, 53,67, 53,66, 53,65, 53,64, 53,63, 54,62, 54,61, 54,60, 54,59, 54,58, 54,57, 54,56, 54,55, 55,54, 56,53, 57,53, 58,52" />
			<area href="$url_view{right}" shape="poly" alt="rotate left (phi++)" coords="54,29, 55,29, 56,29, 57,29, 58,29, 59,29, 60,29, 61,29, 62,29, 63,29, 64,29, 65,29, 66,29, 67,29, 68,29, 69,29, 70,30, 71,30, 72,30, 73,30, 74,30, 75,31, 76,31, 77,31, 78,31, 79,32, 80,32, 81,32, 82,33, 83,33, 84,34, 85,34, 86,34, 87,35, 88,36, 89,36, 90,37, 91,38, 92,39, 92,40, 92,41, 92,42, 92,43, 92,44, 92,45, 92,46, 91,47, 91,48, 90,49, 89,49, 88,50, 87,51, 87,52, 88,53, 88,54, 88,55, 87,55, 86,55, 85,55, 84,55, 83,55, 82,55, 81,55, 80,55, 79,55, 78,54, 77,54, 76,54, 75,54, 74,54, 73,54, 72,54, 71,54, 70,54, 69,53, 68,53, 68,52, 68,51, 69,51, 70,50, 71,50, 72,49, 73,49, 74,48, 75,47, 76,46, 77,45, 77,44, 77,43, 78,43, 79,43, 80,44, 80,45, 81,46, 82,45, 83,44, 83,43, 82,42, 81,41, 80,41, 79,40, 78,40, 77,40, 76,39, 75,39, 74,39, 73,39, 72,38, 71,38, 70,38, 69,38, 68,38, 67,37, 66,37, 65,37, 64,37, 63,37, 62,37, 61,37, 60,37, 59,37, 58,37, 57,36, 56,35, 56,34, 55,33, 54,32, 54,31, 54,30" />
			<area href="$url_view{left}"  shape="poly" alt="rotate right (phi--)" coords="4,32, 5,32, 6,32, 7,32, 8,32, 9,32, 10,32, 11,32, 12,32, 13,32, 14,33, 15,33, 16,33, 17,33, 18,33, 19,33, 20,33, 21,33, 22,33, 23,34, 24,34, 24,35, 24,36, 23,36, 22,37, 21,37, 20,38, 19,38, 18,39, 17,40, 16,41, 15,42, 15,43, 15,44, 14,44, 13,44, 12,43, 11,42, 10,42, 9,43, 9,44, 10,45, 11,46, 12,46, 13,47, 14,47, 15,47, 16,48, 17,48, 18,48, 19,48, 20,49, 21,49, 22,49, 23,49, 24,49, 25,50, 26,50, 27,50, 28,50, 29,50, 30,50, 31,50, 32,50, 33,50, 34,50, 35,51, 36,52, 36,53, 37,54, 38,55, 38,56, 38,57, 38,58, 37,58, 36,58, 35,58, 34,58, 33,58, 32,58, 31,58, 30,58, 29,58, 28,58, 27,58, 26,58, 25,58, 24,58, 23,58, 22,57, 21,57, 20,57, 19,57, 18,57, 17,56, 16,56, 15,56, 14,56, 13,55, 12,55, 11,55, 10,54, 9,54, 8,53, 7,53, 6,53, 5,52, 4,51, 3,51, 2,50, 1,49, 0,48, 0,47, 0,46, 0,45, 0,44, 0,43, 0,42, 0,41, 1,40, 1,39, 2,38, 3,38, 4,37, 5,36, 5,35, 4,34, 4,33" />
		</map>
		<map name="zoom">
			<area href="$url_view{forw}" shape="poly" alt="zoom in" coords="42,0, 43,0, 44,0, 45,0, 46,1, 47,1, 48,2, 49,2, 50,3, 51,4, 52,4, 53,5, 54,6, 55,6, 55,7, 54,7, 53,7, 52,7, 51,7, 50,7, 49,8, 49,9, 50,10, 50,11, 51,12, 51,13, 51,14, 52,15, 52,16, 52,17, 53,18, 53,19, 53,20, 54,21, 54,22, 54,23, 55,24, 55,25, 55,26, 56,27, 56,28, 56,29, 57,30, 57,31, 56,31, 55,31, 54,31, 53,31, 52,31, 51,31, 50,31, 49,31, 48,31, 47,31, 46,31, 45,31, 44,31, 43,31, 42,31, 41,31, 40,31, 39,31, 38,31, 37,31, 36,31, 35,31, 34,31, 33,31, 32,31, 31,31, 30,31, 30,30, 31,29, 31,28, 31,27, 32,26, 32,25, 32,24, 33,23, 33,22, 33,21, 34,20, 34,19, 34,18, 35,17, 35,16, 35,15, 36,14, 36,13, 36,12, 37,11, 37,10, 38,9, 38,8, 37,7, 36,7, 35,7, 34,7, 33,7, 32,7, 32,6, 33,6, 34,5, 35,4, 36,4, 37,3, 38,2, 39,2, 40,1, 41,1" />
			<area href="$url_view{back}" shape="poly" alt="zoom out" coords="26,42, 27,42, 28,42, 29,42, 30,42, 31,42, 32,42, 33,42, 34,42, 35,42, 36,42, 37,42, 38,42, 39,42, 40,42, 41,42, 42,42, 43,42, 44,42, 45,42, 46,42, 47,42, 48,42, 49,42, 50,42, 51,42, 52,42, 53,42, 54,42, 55,42, 56,42, 57,42, 58,42, 59,42, 60,42, 61,42, 61,43, 61,44, 62,45, 62,46, 62,47, 63,48, 63,49, 64,50, 64,51, 64,52, 65,53, 65,54, 66,55, 67,55, 68,55, 69,55, 70,55, 71,55, 72,55, 73,55, 74,55, 75,55, 76,55, 77,55, 78,55, 79,55, 80,55, 81,55, 82,55, 83,55, 84,55, 85,55, 86,55, 87,55, 87,56, 86,57, 85,58, 84,58, 83,59, 82,60, 81,60, 80,61, 79,62, 78,63, 77,63, 76,64, 75,65, 74,65, 73,66, 72,67, 71,68, 70,68, 69,69, 68,70, 67,70, 66,71, 65,72, 64,73, 63,73, 62,74, 61,75, 60,75, 59,76, 58,77, 57,78, 56,78, 55,79, 54,80, 53,80, 52,81, 51,82, 50,83, 49,83, 48,84, 47,85, 46,85, 45,86, 44,86, 43,86, 42,86, 41,85, 40,85, 39,84, 38,83, 37,83, 36,82, 35,81, 34,80, 33,80, 32,79, 31,78, 30,78, 29,77, 28,76, 27,75, 26,75, 25,74, 24,73, 23,73, 22,72, 21,71, 20,70, 19,70, 18,69, 17,68, 16,68, 15,67, 14,66, 13,65, 12,65, 11,64, 10,63, 9,63, 8,62, 7,61, 6,60, 5,60, 4,59, 3,58, 2,58, 1,57, 0,56, 0,55, 1,55, 2,55, 3,55, 4,55, 5,55, 6,55, 7,55, 8,55, 9,55, 10,55, 11,55, 12,55, 13,55, 14,55, 15,55, 16,55, 17,55, 18,55, 19,55, 20,55, 21,55, 22,54, 22,53, 23,52, 23,51, 23,50, 24,49, 24,48, 25,47, 25,46, 25,45, 26,44, 26,43" />
		</map>
EOF

my %p_extra = ();
$p_extra{clicku} = $clicku if $clicku ne -1;
$p_extra{clickv} = $clickv if $clickv ne -1;
my $plot_url = make_url("plot.pl", \%p, %p_extra);
my $click_url = make_url($uri, \%p);

print <<EOF;
		<table border="0" cellspacing="0" cellpadding="0">
			<tr>
				<td colspan="5">
				 <a href="${click_url}click="><img alt="[3d]" border="0" src="$plot_url" width="800"
				  ismap="ismap" height="450" style="border: 1px solid white" /></a></td>
			</tr>
			<tr valign="top">
				<td width="10%">
EOF

if (open FH, "< " . _PATH_LEGEND) {
	print <FH>;
	close FN;
}

print <<EOF;
</td>
				<td width="60%" align="right">
					<div style="float: right">
						<img alt="[zoom]" border="0" usemap="#zoom" src="img/zoom.png"
						 style="vertical-align: middle" style="padding: 1px; padding-left: 5px"
						 /><img alt="[view]" border="0" usemap="#view" src="img/sphere.png"
						 style="vertical-align: middle; padding: 1px; padding-left: 5px" /></div>
					<div id="pl_node" style="text-align: left; float: right"></div>
					</td>
			</tr>
		</table>
		<hr />
		<div class="micro">Copyright &copy; 2005
		  <a href="http://www.psc.edu/">Pittsburgh Supercomputing Center</a></div>
		<script type='text/javascript'><!--
EOF

print "seljob($p{job})\n" if $p{job};

print <<EOF;
		// -->
		</script>
	</body>
</html>
EOF

sub make_url {
	my ($page, $rp, %params) = @_;
	my $url = $page . "?";
	foreach (keys %$rp) {
		if (exists $params{$_}) {
			$url .= "$_=$params{$_}&amp;";
			delete $params{$_};
		} elsif (exists $rp->{$_} && $rp->{$_}) {
			$url .= "$_=$rp->{$_}&amp;";
		}
	}
	foreach (keys %params) {
		$url .= "$_=$params{$_}&amp;";
	}
	return ($url);
}

# vim: set ts=2:
